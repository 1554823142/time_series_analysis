# 自回归模型



- 今天找到一个中文翻译的时序分析教材:[**预测:方法与实践**](https://otexts.com/fppcn/)

## 含义

通过将*当前值与过去若干期的值*进行**线性组合**来预测未来的值。AR模型的核心思想是利用时间序列**自身的滞后值**（即历史数据）来建模和预测，因此得名*“自回归”*。

- **数学表达式:**
  $$
  X_t = c+\phi_1X_{t-1}+\phi_2X_{t-2}+\dots+\phi_pX_{t-p}+\epsilon_t
  $$

  - $$X_t$$: 时间序列在$$t$$点的值
  - $$\phi_i$$为模型参数, 为滞后值的权重
  - $$p$$为模型的阶数, 表示考虑的滞后数量
  - $$\epsilon_t$$为误差项, 通常设置为**白噪声**(即均值为0，方差为常数的随机变量)

- **性质:**

  - **平稳性**：AR模型要求时间序列是平稳的，即均值、方差和自协方差不随时间变化。如果序列不平稳，通常需要先进行差分或其他变换。
  - **线性关系**：AR模型假设时间序列的当前值与滞后值之间存在线性关系。
  - **白噪声误差**：误差项 $$\epsilon_t$$ 应该是白噪声，即均值为0，方差为常数，且相互独立

- **AR模型与其他模型的关系**

  - **ARIMA模型**：AR模型是ARIMA模型的特例，ARIMA模型在AR模型的基础上*增加了差分（I）和移动平均（MA）部分*。
  - **ARMA模型**：ARMA模型是*AR模型和MA模型的结合*，同时考虑了滞后值和误差项的动态关系

## AR模型_R

### AR阶次的选择---**赤池信息量准则**

- **赤池信息量准则**（Akaike information criterion，**AIC**）

  - 准则等式
    $$
    AIC = 2k - 2lnL
    $$

    - $$k$$为模型参数的个数, $$L$$为最大似然函数

  - 目的: 

    降低模型复杂度的同时(减少$$k$$), 同时提高模型的似然性/拟合度(增大$$L$$)

    这也是一个优化目标函数(惩罚函数), 使得$$AIC$$的值最小

### ARIMA 模型(AutoRegressive Integrated Moving Average)

**差分自回归移动平均模型**

本质就是把数据中带有趋势的(`trend`)的，带有季节性的(`seasonal`)的, 带有业务场景周期性(`domain cycle`)的规律先找出来，*一层一层将有规律的信息从数据中抽出来*，最后的数据就剩下没有规律的，或叫噪声，理想的时候是**白噪声**(`white noise series`)

因为具有趋势和季节性的时间序列不是平稳时间序列, 而白噪声序列是平稳的

$$
y'_t=c+\phi_1y'_{t-1}+\dots+\phi_py'_{t-p} + \theta_1\epsilon_{t-1}+\dots+\theta_q\epsilon_{t-q}+\epsilon_t
$$
其中$$y'$$为差分序列(可能进行了多次差分), 此模型称为`ARIMA(p,d,q)`模型($$p$$:自回归模型阶数,$$d$$:差分阶数, $$q$$:移动平均模型阶数)

- ARIMA模型的特例:

  | 白噪声               | $$ARIMA(0,0,0)$$                  |
  | -------------------- | --------------------------------- |
  | 随机游走模型         | $$ARIMA(0,1,0)$$ with no constant |
  | 带漂移的随机游走模型 | $$ARIMA(0,1,0) $$ with a constant |
  | 自回归模型           | $$ARIMA(p,0,0)$$                  |
  | 移动平均模型         | $$ARIMA(0,0,q)$$                  |

  - R中的`arima`函数
  
    - 语法:
  
      ```R
      arima(x, order = c(p, d, q), seasonal = list(order = c(P, D, Q), period = s),
            xreg = NULL, include.drift = FALSE, method = c("CSS-ML", "ML"), ...)
      ```
  
      - `order`:包含3个整数的向量, 表示ARIMA模型的参数(p, d, q)
      - `fixed`: 与模型参数一一对应，值为 **NA** 或一个特定数值, 其中`NA` 表示该参数需要被估计, 而一个具体数值表示该参数被固定为该值，不进行估计
  
  - R中一种更加简单拟合arima模型的方法：`auto.arima()`
  
    自动选择最优的 ARIMA 模型阶数。用户只需要提供时间序列数据，函数会自动进行阶数选择，避免了手动选择 `p`、`d`、`q` 的麻烦
  
    - 示例:参照[**预测:方法与实践**](https://otexts.com/fppcn/)
  
      ```R
      library(fpp2)
      # 查看 uschange 数据
      data("uschange")
      autoplot(uschange[,"Consumption"]) +
        xlab("年份") + ylab("季度占比变化")+
        theme(plot.title = element_text(hjust = 0.5))
      
      fit <- auto.arima(uschange[,"Consumption"], seasonal = FALSE)
      ```
  
      输出如下:
  
      ```javascript
      Series: uschange[, "Consumption"] 
      ARIMA(1,0,3) with non-zero mean 
      
      Coefficients:
               ar1      ma1     ma2     ma3    mean
            0.5885  -0.3528  0.0846  0.1739  0.7454
      s.e.  0.1541   0.1658  0.0818  0.0843  0.0930
      
      sigma^2 = 0.3499:  log likelihood = -164.81
      AIC=341.61   AICc=342.08   BIC=361
      ```
  
      显示模型为:
      $$
      y_t=c+0.5885y_{t-1}-0.3528\epsilon_{t-1}+0.0846\epsilon_{t-2}+0.1739\epsilon_{t-3}+\epsilon_t
      $$
      其中$$c = 0.7454\times(1-0.5885+NA)$$,$$\epsilon_t=\sqrt{sigma^2}$$
    
  - ps: 自回归移动平均模型不一定是唯一的
  
    eg:有以下自回归移动平均模型:
    $$
    y_t=0.5\times y_{t-1}+0.24\times y_{t-2}+e_{t-1}+0.09\times e_{t-2}
    $$
    将自回归项与移动平均项各自放在一侧:
    $$
    y_t-0.5\times y_{t-1}-0.24\times y_{t-2}=e_{t}+0.6\times e_{t-1}+0.09\times e_{t-2}
    $$
    然后使用后移算子重写:
    $$
    y_t-0.5\times L \times y_t - 0.24 \times L^2 \times y_t = e_t +0.6 \times L \times e_t + 0.09 \times L^2 \times e_t
    $$
     然后因式分解可以消去一次, 这样就简化了
  

#### Wold定理

>  任何协方差平稳的时间序列都可以写成两个时间序列之和，其中一个是确定性的，另一个是随机的。这为我们建立ARIMA模型建立了基础.

- 定义

  设$$X_i$$为一列idd, 且每个$$X_i$$的期望值为$$E[X_i]=\mu$$, 如果$$N$$是一个独立的随机变量, 表示实验的次数, 其期望值为$$E[N]$$, 则定理表明:
  $$
  E[\sum^N X_i]=E[N]\cdot E[X_1]
  $$

- 作用

  意义在于它简化了计算复杂的随机过程的期望值

## 扬–博克斯检验（**Ljung-Box Test**)

- **原理:**

检验时间序列数据**是否存在自相关性**，特别是**检查残差是否为白噪声**

该检验的目的是检查模型的残差是否与时间序列的**滞后**相关，从而评估模型的拟合质量。如果残差不是白噪声，说明模型没有完全捕捉到数据中的规律。

### 步骤

- 从模型中提取残差:  $$\epsilon_t = y_t - \hat{y}_t$$

  假设已经拟合了一个时间序列的模型(如ARIMA), 其中$$\hat{y}_t$$为预测值

- 计算每个滞后期 $$k$$ 的自相关系数 $$\hat{\rho}_k$$，并选择一个滞后期范围 $$h$$

  如: $$\hat{\rho}_1$$ 为$$y_t$$和$$y_{t-1}$$的自相关系数

  如果时间序列数据是完全的白噪声，那么这些自相关系数应当接近于零

- 根据公式计算 Ljung-Box 检验的统计量 $$Q$$

  检验统计量的计算公式为:
  $$
  Q=n(n+2)\sum_{k=1}^h \frac{\rho_k^2}{n-k}
  $$
  其中：

  - $$Q$$ 是检验统计量。
  - $$n$$是样本的总数据点数。
  - $$h$$ 是滞后期的最大值（通常选择较小的滞后期，例如 10）。
  - $$\hat{\rho}_k$$ 是第 $$k$$个滞后的自相关系数。
  - $$n-k$$ 是样本的自由度调整。

- 计算 p 值，判断是否拒绝零假设

  假设我们选择了显著性水平 $$\alpha = 0.05$$，如果$$p$$ 值大于 $$0.05$$，就不能拒绝零假设（即残差是白噪声），说明模型拟合得很好，残差没有显著的自相关性。如果$$ p$$ 值小于 $$0.05$$，则拒绝零假设，意味着残差存在显著的自相关性，说明模型的拟合存在问题。

- 假设检验

  Ljung-Box 检验的假设为：

  - **零假设（$$H_0$$）**：残差是白噪声，所有的自相关系数为零，或者没有显著的自相关性。
  - **备择假设（$$H_1$$）**：残差存在显著的自相关性，即至少有一个滞后期的自相关系数显著不为零

### R 中的Box.test()函数

- 语法:

  ```R
  box.test(x, lag = 1, type = c("Ljung-Box", "Box-Pierce"), fitdf = 0, ...)
  ```

  - `x`: 要进行 Ljung-Box 检验的时间序列。通常，`x` 是时间序列的**残差**，它来自已拟合的模型，如 `ARIMA` 模型。
  - `lag`: 对应于公式中的$$h$$值
  - `type`: 取值 `"Ljung-Box"` 或 `"Box-Pierce"`
    - `"Ljung-Box"`：Ljung-Box 检验，调整了样本量，以使得统计量更加准确。
    - `"Box-Pierce"`：Box-Pierce 检验，不考虑样本容量的调整，计算上更为简洁，但可能在样本量较小的情况下不太准确。
  - `fitdf`: 拟合模型的**自由度**, 为模型中已估计的**参数数量**

- 示例:

  ```R
  Box.test(est_1$residuals, lag = 10, type = "Ljung", fitdf = 3)
  ```

  输出:

  ```javascript
  Box-Ljung test
  
  data:  est_1$residuals
  X-squared = 54.064, df = 7, p-value = 2.284e-09
  ```

  p值较小, 说明模型拟合的不好



## 注意

自回归模型适合做**短期预测**, 对遥远的未来的数据不具备预测能力

