# 针对时间序列的探索性数据分析

## 概念

- **横截面数据**（Cross-sectional data）

  是指**在某一特定时间点或某一短时间内**，对多个个体、实体或观察对象进行收集的数据。这些数据展示了在该时间点上各个个体或单位之间的差异，而不涉及时间序列的动态变化。横截面数据通常用于研究不同个体、地区或国家在**同一时刻**的状态或行为差异。

  与之相对的是**时间序列数据**（Time series data），它关注的是单个实体在不同时间点上的数据变化；而**面板数据**（Panel data）则结合了横截面数据和时间序列数据，即对多个个体在多个时间点进行跟踪和观察。

​	

## 时间序列的性质

### 平稳性(stationarity)

具体来说就是**均值和方差随时间保持平稳**

- **平稳性的定义**

  如果对于所有可能的时间间隔$ k,y_t, y_{t+1}, ..., y_{t+k}$的分布不依赖于时刻$t$，则该过程是平稳的

  检验方法通常归结为是否存在**单位根**的问题，即**1**是否为随机过程特征方程的解

- **例子**(随机游走 -- 不满足平稳性)

  一维随机游走可表示为: (这也是AR(1)模型的$\phi$为1的情况)
  $$
  X_t = X_{t - 1} + \epsilon_t
  $$
  $X_t$表示第 $t$步的位置，$\epsilon_t$ 是一个随机变量，通常取 $\pm 1$，表示向左或向右移动

  序列中的值会在一个趋势上增长或下降，而不是围绕某个常数波动, 时间序列将随着时间逐步累积误差 $\epsilon _t$，导致序列**没有一个固定的均值或方差**，从而是**非平稳的**

- **检验**

  **增广迪基–富勒检验**（Augmented Dickey–Fuller test，简称ADF检验）--- 评估时间序列是否平稳的最常用的检验方法

  由于时间平稳性检验关注时间序列的均值是否一直变化, ，判断时间序列是否平稳的检验其实是检验它是否经过**差分转换**就可以变得平稳，更准确地说，**时间序列是否经过$d$阶差分处理之后就能变得平稳**

  检验框架为:
  $$
  \Delta y_t = y_t  - y_{t - 1} = (\phi - 1) \times y_{t - 1} + \epsilon _t
  $$
  $\phi = 1$是否为真是否为真, 但是此检验方法的不同之处在于考虑了更高阶, 表示为:
  $$
  Y_t - \phi _1 \times y_{t - 1} - \phi_2 \times y_{t -2} ... = \epsilon _t
  $$
  

​	

- 非平稳时间序列的变换

  - 使用**对数变换和平方根变换**, 其中对数变换相对强烈, 平方根相对平和

    **对数变换**适用于处理具有指数增长、呈现强烈异方差性或者偏斜的时间序列

    **平方根变换**适用于数据较为均匀、但仍存在异方差性或右偏分布的情况

    虽然两种方法可以减小随时间变化的方差, 但是是做出了几个假设: 	

    - 数据总是向上（或符合单调性）的 
    - 可以使较大值之间的差异减小，从而有效地压缩较大值之间的空间，但**不会压缩较小值之间的空间**，由此消除了异常值之间的差异, 可能合适, 也可能不合适

  - 使用差分

    去除序列中的趋势成分，使序列变得更加平稳, 低阶差分后序列不平稳, 可以继续使用高阶差分,  差分过程的次数通常会通过自相关图（ACF）和偏自相关图（PACF）来确定

  - 正态分布的变换 --- **博克斯–考克斯变换**（Box-Cox transformation）

​		R的`forecast`包和Python的`scipy.stats`已经实现了这种变换

​		使非正态分布的数据（倾斜的数据）正态化

​		BOX-COX一般形式为:

$$
Y_t(\lambda) = 
				\begin{cases}
				Y_t ^ \lambda  -1, & \lambda \ne 0 \\
				log(Y_t), 		   & \lambda = 0
				
				\end{cases}
$$
​		通过$\lambda$来控制变换的形式

​			$\lambda = 1$: 不进行变换

​			$\lambda = 0$: 对数变换

​			$\lambda = 0.5$:进行平方根变换

​			$\lambda = 2$:进行平方变换	

​		ps:**Yeo-Johnson 变换**, 可以处理负值和零值的数据	

$$
Y_t(\lambda) = 
			\begin{cases}
			\frac{(Y_t ^ \lambda - 1) ^ \lambda - 1}{\lambda} , & Y_t \geq 0 \\
			- \frac{(-Y_t + 1) ^{2 - \lambda} - 1}{2 - \lambda},& Y_t \lt 0
			\end{cases}
$$
​		通过 **最大似然估计（MLE）** 来选择最佳的 $\lambda$ 值

### 自相关性

- **定义**:

  自相关也叫序列相关，它是指一个信号与其自身延迟的副本之间的相关性。一般来说，它体现了观测值之间的相似性，与观测值的时间差存在函数关系。自相关体现了在一段时间序列里，**不同时刻的数据点之间**的线性关系。这个线性关系与数据点的时间差有关。

- **计算公式**

  - 皮尔逊相关系数

    衡量**两个变量之间**线性关系的强度和方向的统计量($\rho = 1$表示完全正相关)

     R 中，`cor()` 函数用于计算两个向量或时间序列之间的相关性
    $$
    \rho _{xy} = \frac{\sum_{i=1}^n(x_i - \bar{x})(y_i - \bar{y})}{\sqrt{\sum_{t=1}^T (x_t - \bar{x})^2 \sum_{t=1}^T (y_t - \bar{y})^2}}
    $$
  
- 自相关系数
  
  指时间序列在不同滞后（lag）下**自身与其过去值**之间的相关性。通常用于描述一个时间序列**自身在不同时间点之间的相关性**

$$
\rho_k = \frac{\sum_{t = k+1}^T (x_t - \bar{x})(x_{t-k} - \bar{x})}{\sum_{t=1}^T (x_t - \bar{x})^2}
$$

- **自相关函数(ACF)性质**

  - 周期函数的 ACF 具有和原函数相同的周期

  - 由多个周期函数组合的自相关性是每个函数的自相关性之和(即**线性性**)

  - 所有时间序列在滞后量为0时的自相关性均为1

  - 在除0以外的其他滞后情况下，白噪声样本的自相关性近似于0

    **`白噪声`**是指没有任何规律或模式的随机信号，其各个时刻的值之间是独立的。由于**缺乏依赖关系**，白噪声的自相关函数在滞后量非零时接近于零

    对应于ACF图像显示为所有的自相关值均落在**边界之内**, 对于一个长度为$$T$$的白噪声序列而言，我们期望在0.95的置信度下，它的自相关值处于$$±2/\sqrt T$$之间

  - 时间序列的正负滞后量的 ACF 是对称的, 即
    $$
    \rho_t = \rho_{-t}
    $$

  - 显著非零的 ACF 应用临界区域 $$\pm 1.96 \times \sqrt{1/n}$$

    一个常用的统计规则是，当 ACF 值超过  $$\pm 1.96 \times \sqrt{1/n}$$时，认为其自相关性是显著非零的(其中$n$为样本大小) 如果 ACF 的值**超出**这个区间，则可以认为该滞后期的**自相关性显著**

- **偏自相关函数(PACF)**

  **偏自相关函数**（partial autocorrelation function，**PACF**）
  
  简单来看, PACF只描述观测值$$Y_t$$与其滞后项$$Y_{t-k}$$之间的直接关系, 而调整了其他的较短滞后项($$Y_{t-1\dots t-k-1}$$)的影响

### 伪相关性

- 导致原因

   - 时间序列中的趋势

     当两个时间序列都包含长期趋势（例如，经济增长、人口增长、温度变化等），它们可能会同时上升或下降，导致看起来有相关性，但实际上这只是由于**趋势的共同存在**，而不是它们之间的直接关系

   - 季节性（季节性伪相关性）

     两个时间序列具有季节性, 并且这些季节性模式恰好**发生在相同的时间**，可能导致它们看起来相关

   - 数据的非平稳性

- 概念区分---**协整**

  书上一个有趣的例子:

  > 一个常用于说明协整的例子是醉酒的行人和他的狗。单独测量行人和狗的步调，会发现二者看起来是完全随机的，但是二者能保持相近的距离.

  **非平稳时间序列的线性组合**：假设有两个非平稳的时间序列$X_t$ 和 $Y_t$，如果存在某个常数 $\beta$ 使得它们的线性组合 $Z_t = X_t - \beta Y_t$是平稳的，那么这两个时间序列就是**协整**的。

  换句话说，尽管 $X_t$ 和 $Y_t$ 各自可能存在趋势（即非平稳），但它们之间的**长期关系是稳定的**，即它们的**差距（或线性组合）**在统计上是恒定的。

  - 协整的检验

    Engle-Granger二步法（EG）:

    - 对两个非平稳时间序列 $X_t$ 和 $Y_t$ 进行回归，得到残差项 $e_t = X_t - \hat{\beta} Y_t$
    - 检验残差 $e_t$是否平稳。如果残差是平稳的，则可以认为 $X_t$和 $Y_t$ 协整

  - 与伪相关性的区别

    重要区别在于，伪相关的时间序列之间**不一定**存在任何关系，而协整时间序列则**彼此密切相关**



​		
